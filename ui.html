<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      font-family: "Inter", sans-serif;
      font-size: 13px;
      background: #F4F4F5;
      color: #18181B;
      overflow: hidden;
    }

    /* ── PAGE CONTAINER ── */
    .pages {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .pages.show-results { transform: translateX(-50%); }

    .page {
      width: 50%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 14px;
      gap: 10px;
      overflow: hidden;
      flex-shrink: 0;
    }

    /* ── HEADER ── */
    .header { display: flex; align-items: flex-start; gap: 8px; }
    .header-text { flex: 1; }
    .header h1 { font-size: 14px; font-weight: 600; }
    .header .subtitle { font-size: 11px; color: rgba(24,24,27,.5); margin-top: 2px; line-height: 1.4; }

    .back-btn {
      display: flex; align-items: center; gap: 5px;
      padding: 5px 10px; background: white; color: rgba(24,24,27,.65);
      font-family: "Inter", sans-serif; font-size: 11px; font-weight: 500;
      border: 1.5px solid #E4E4E7; border-radius: 7px;
      cursor: pointer; transition: all .15s; white-space: nowrap; flex-shrink: 0;
    }
    .back-btn:hover { background: #F4F4F5; color: #18181B; border-color: #D4D4D8; }
    .back-btn svg { width: 13px; height: 13px; flex-shrink: 0; }

    /* ── SELECTION ── */
    .panel-label {
      font-size: 10px; font-weight: 600; letter-spacing: .06em;
      text-transform: uppercase; color: rgba(24,24,27,.45); padding: 0 2px;
    }

    .tag-row {
      display: flex; flex-wrap: wrap; gap: 5px;
      padding: 8px 10px; background: white; border-radius: 8px;
      border: 1.5px solid #E4E4E7; min-height: 38px; align-items: center;
    }
    .tag-row.has-items.dest-row { border-color: #7C3AED; }
    .tag-row.has-items.src-row  { border-color: #4361EE; }
    .tag-row.empty-row { border-style: dashed; }

    .empty-hint { font-size: 11px; color: rgba(24,24,27,.35); }

    .tag {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 7px 3px 5px; border-radius: 5px;
      font-size: 11px; font-weight: 500; max-width: 200px;
    }
    .tag-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tag-badge { font-size: 9px; font-weight: 700; background: rgba(0,0,0,.12); border-radius: 3px; padding: 1px 4px; flex-shrink: 0; }
    .tag-set       { background: #F5F0FF; color: #6D28D9; border: 1px solid #DDD6FE; }
    .tag-component { background: #EEF1FD; color: #3730A3; border: 1px solid #C7D2FE; }
    .tag-instance  { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
    .tag-frame     { background: #F0FDF4; color: #15803D; border: 1px solid #BBF7D0; }

    /* ── DIVIDER ── */
    .divider { height: 1px; background: #E4E4E7; flex-shrink: 0; }

    /* ── RUN BUTTON ── */
    .run-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 20px; background: #4361EE; color: white;
      font-family: "Inter", sans-serif; font-size: 13px; font-weight: 600;
      border: none; border-radius: 8px; cursor: pointer; transition: background .15s;
      flex-shrink: 0;
    }
    .run-btn:hover:not(:disabled) { background: #2D41E3; }
    .run-btn:disabled { opacity: .38; cursor: not-allowed; }
    .run-btn svg { width: 14px; height: 14px; flex-shrink: 0; }

    /* ── IDLE HINT ── */
    .idle-hint {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 8px; color: rgba(24,24,27,.35); font-size: 11px;
      text-align: center; padding: 16px; line-height: 1.5;
    }
    .idle-hint svg { width: 28px; height: 28px; }

    /* ── PHASE STEPPER ── */
    .phase-stepper {
      display: none; flex-direction: column;
      background: white; border: 1.5px solid #E4E4E7; border-radius: 10px;
      overflow: hidden; flex-shrink: 0;
    }
    .phase-stepper.visible { display: flex; }

    .phase-row {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 12px; font-size: 11px;
      border-bottom: 1px solid #F4F4F5;
    }
    .phase-row:last-child { border-bottom: none; }
    .phase-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
      background: #E4E4E7; transition: background .3s;
    }
    .phase-row.active   .phase-dot { background: #4361EE; box-shadow: 0 0 0 3px rgba(67,97,238,.2); }
    .phase-row.complete .phase-dot { background: #16A34A; }
    .phase-label {
      font-size: 10px; font-weight: 600; flex-shrink: 0;
      min-width: 52px; text-transform: uppercase; letter-spacing: .04em;
      color: rgba(24,24,27,.35);
    }
    .phase-row.active   .phase-label { color: #4361EE; }
    .phase-row.complete .phase-label { color: #16A34A; }
    .phase-msg { flex: 1; color: rgba(24,24,27,.5); font-size: 11px; }
    .phase-row.active   .phase-msg { color: #18181B; }
    .phase-row.complete .phase-msg { color: rgba(24,24,27,.55); }

    /* ── RESULTS PAGE ── */
    .results-header-bar {
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .results-header-bar h1 { font-size: 14px; font-weight: 600; }

    .stat-pills { display: flex; gap: 4px; flex-wrap: wrap; }
    .pill { font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 20px; }
    .pill.ok      { background: #DCFCE7; color: #15803D; }
    .pill.fail    { background: #FEE2E2; color: #B91C1C; }
    .pill.skip    { background: #FEF9C3; color: #854D0E; }
    .pill.neutral { background: #F4F4F5; color: rgba(24,24,27,.55); }

    .results-box {
      border: 1.5px solid #E4E4E7; border-radius: 10px;
      background: white; overflow: hidden;
      flex: 1; display: flex; flex-direction: column; min-height: 0;
    }

    .result-tabs { display: flex; border-bottom: 1px solid #E4E4E7; flex-shrink: 0; }
    .result-tab {
      flex: 1; padding: 7px 0; font-size: 11px; font-weight: 500;
      color: rgba(24,24,27,.45); cursor: pointer; text-align: center;
      border-bottom: 2px solid transparent; transition: all .15s; user-select: none;
    }
    .result-tab.active          { color: #4361EE; border-bottom-color: #4361EE; }
    .result-tab.skip-tab.active { color: #92400E; border-bottom-color: #D97706; }
    .result-tab.fail-tab.active { color: #B91C1C; border-bottom-color: #DC2626; }

    .tab-panel { display: none; flex: 1; overflow-y: auto; padding: 8px; flex-direction: column; gap: 4px; }
    .tab-panel.active { display: flex; }

    .result-item { display: flex; align-items: flex-start; gap: 7px; padding: 7px 9px; border-radius: 7px; }
    .result-item.ok   { background: #F0FDF4; }
    .result-item.fail { background: #FEF2F2; }

    .ri-icon { width: 14px; height: 14px; flex-shrink: 0; margin-top: 1px; }
    .ri-body { flex: 1; min-width: 0; }
    .ri-node { font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ri-detail { font-size: 10px; color: rgba(24,24,27,.5); margin-top: 2px; line-height: 1.4; }
    .ri-arrow { color: #4361EE; font-weight: 700; margin: 0 3px; }
    .ri-prop {
      display: inline-block; background: #EEF1FD; color: #4361EE;
      font-size: 9px; font-weight: 600; border-radius: 3px; padding: 1px 4px; margin-right: 4px;
    }

    /* ── Skip rows ── */
    .skip-group {
      display: flex; align-items: center; gap: 7px;
      padding: 7px 9px;
      background: #FFFBEB; border: 1.5px solid #FDE68A; border-radius: 8px;
      cursor: pointer; user-select: none;
      transition: background .1s, border-color .1s, opacity .15s;
    }
    .skip-group:hover:not(.done) { background: #FEF3C7; border-color: #F59E0B; }
    /* selected via shift-click */
    .skip-group.selected:not(.done) {
      background: #EFF6FF; border-color: #93C5FD;
    }
    .skip-group.selected:hover:not(.done) { background: #DBEAFE; border-color: #60A5FA; }
    /* done */
    .skip-group.done { background: #F9FAFB; border-color: #D4D4D8; opacity: .45; cursor: default; }

    .skip-warn-icon { width: 13px; height: 13px; flex-shrink: 0; color: #D97706; }
    .skip-group.done    .skip-warn-icon  { color: #A1A1AA; }
    .skip-group.selected:not(.done) .skip-warn-icon { color: #3B82F6; }

    .skip-name-label {
      flex: 1; min-width: 0; font-size: 11px; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #18181B;
    }
    .skip-group.done     .skip-name-label { text-decoration: line-through; color: #71717A; }
    .skip-group.selected:not(.done) .skip-name-label { color: #1D4ED8; }

    .skip-name-count {
      font-size: 10px; font-weight: 700; background: rgba(0,0,0,.07);
      color: #92400E; border-radius: 20px; padding: 2px 7px; flex-shrink: 0;
    }
    .skip-group.done     .skip-name-count { color: #A1A1AA; background: rgba(0,0,0,.05); }
    .skip-group.selected:not(.done) .skip-name-count { color: #1D4ED8; background: rgba(59,130,246,.12); }

    /* Done toggle button */
    .skip-done-toggle {
      font-size: 10px; font-weight: 600; flex-shrink: 0;
      padding: 2px 8px; border-radius: 5px; cursor: pointer;
      border: 1.5px solid #E4E4E7; background: white; color: rgba(24,24,27,.4);
      font-family: "Inter", sans-serif; transition: all .12s; line-height: 1.6;
    }
    .skip-done-toggle:hover { border-color: #18181B; color: #18181B; }
    .skip-group.done .skip-done-toggle {
      border-color: #16A34A; background: #DCFCE7; color: #15803D;
    }
    .skip-group.done .skip-done-toggle:hover { background: #BBF7D0; }



    .tab-empty {
      flex: 1; display: flex; align-items: center; justify-content: center;
      font-size: 11px; color: rgba(24,24,27,.4); text-align: center; padding: 16px; line-height: 1.5;
    }

    .spinner {
      width: 15px; height: 15px;
      border: 2px solid rgba(255,255,255,.35); border-top-color: white; border-radius: 50%;
      animation: spin .7s linear infinite; display: inline-block; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .selection-panel { display: flex; flex-direction: column; gap: 6px; }
  </style>
</head>
<body>

<div class="pages" id="pages">

  <!-- ══════════════════════════════════════════════ -->
  <!-- PAGE 1 — SELECTION                            -->
  <!-- ══════════════════════════════════════════════ -->
  <div class="page" id="page-selection">

    <div class="header">
      <div class="header-text">
        <h1>Variable Substitution</h1>
        <div class="subtitle">Substitui variáveis por nome — cores, tipografia e efeitos</div>
      </div>
    </div>

    <div class="selection-panel">
      <div class="panel-label">Destino — Component Set / Component / Instance</div>
      <div class="tag-row dest-row empty-row" id="targetsRow">
        <span class="empty-hint" id="targetsEmpty">Selecione componentes ou component sets</span>
      </div>
      <div class="panel-label">Origem das variáveis — Frames</div>
      <div class="tag-row src-row empty-row" id="framesRow">
        <span class="empty-hint" id="framesEmpty">Selecione um ou mais Frames</span>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Phase stepper shown while running -->
    <div class="phase-stepper" id="phaseStepper">
      <div class="phase-row" id="phase-collecting">
        <div class="phase-dot"></div>
        <span class="phase-label">Coleta</span>
        <span class="phase-msg" id="msg-collecting">Aguardando...</span>
      </div>
      <div class="phase-row" id="phase-p1">
        <div class="phase-dot"></div>
        <span class="phase-label">Fase 1</span>
        <span class="phase-msg" id="msg-p1">Componentes mães</span>
      </div>
      <div class="phase-row" id="phase-p2">
        <div class="phase-dot"></div>
        <span class="phase-label">Fase 2</span>
        <span class="phase-msg" id="msg-p2">Instâncias externas</span>
      </div>
    </div>

    <!-- Idle hint shown when not running -->
    <div class="idle-hint" id="idleHint">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>
      </svg>
      Selecione os destinos e os frames de origem,<br>depois clique em "Substituir variáveis"
    </div>

    <button class="run-btn" id="runBtn" disabled onclick="run()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
      Substituir variáveis
    </button>

  </div><!-- /page-selection -->

  <!-- ══════════════════════════════════════════════ -->
  <!-- PAGE 2 — RESULTS                              -->
  <!-- ══════════════════════════════════════════════ -->
  <div class="page" id="page-results">

    <div class="results-header-bar">
      <button class="back-btn" onclick="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Nova substituição
      </button>
      <div class="stat-pills" id="statPills"></div>
    </div>

    <div class="results-box">
      <div class="result-tabs">
        <div class="result-tab active"   onclick="switchTab('ok')"   id="tab-ok">✓ Aplicadas</div>
        <div class="result-tab skip-tab" onclick="switchTab('skip')" id="tab-skip" style="display:none">⚠ Ignoradas</div>
        <div class="result-tab fail-tab" onclick="switchTab('fail')" id="tab-fail" style="display:none">✗ Falhas</div>
      </div>
      <div class="tab-panel active" id="panel-ok"></div>
      <div class="tab-panel"        id="panel-skip"></div>
      <div class="tab-panel"        id="panel-fail"></div>

    </div>

  </div><!-- /page-results -->

</div><!-- /pages -->

<script>
  let hasTargets = false;
  let hasFrames  = false;
  let isRunning  = false;

  // ── Navigation ─────────────────────────────────────────────────────────

  function showResults() {
    document.getElementById('pages').classList.add('show-results');
  }

  function goBack() {
    document.getElementById('pages').classList.remove('show-results');
    // Reset stepper for next run
    resetStepper();
    setRunning(false);
  }

  // ── Phase stepper ───────────────────────────────────────────────────────

  function resetStepper() {
    ['phase-collecting','phase-p1','phase-p2'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove('active','complete');
    });
    document.getElementById('msg-collecting').textContent = 'Aguardando...';
    document.getElementById('msg-p1').textContent         = 'Componentes mães';
    document.getElementById('msg-p2').textContent         = 'Instâncias externas';
    document.getElementById('phaseStepper').classList.remove('visible');
    document.getElementById('idleHint').style.display = 'flex';
  }

  const PHASES = [
    { key: 'collecting',        rowId: 'phase-collecting', msgId: 'msg-collecting' },
    { key: 'phase1_components', rowId: 'phase-p1',         msgId: 'msg-p1'         },
    { key: 'phase2_instances',  rowId: 'phase-p2',         msgId: 'msg-p2'         },
    { key: 'done',              rowId: 'phase-p2',         msgId: 'msg-p2'         },
  ];

  function setPhase(phaseKey, message) {
    const currentIdx = PHASES.findIndex(p => p.key === phaseKey);
    if (currentIdx === -1) return;

    const uniqueRows = ['phase-collecting', 'phase-p1', 'phase-p2'];
    uniqueRows.forEach((rowId, i) => {
      const row = document.getElementById(rowId);
      if (!row) return;
      row.classList.remove('active', 'complete');
      if (i < currentIdx) row.classList.add('complete');
      else if (i === Math.min(currentIdx, 2)) row.classList.add('active');
    });

    if (message) {
      const p = PHASES[currentIdx];
      const el = document.getElementById(p.msgId);
      if (el) el.textContent = message;
    }

    if (phaseKey === 'done') {
      document.getElementById('phase-p2').classList.remove('active');
      document.getElementById('phase-p2').classList.add('complete');
    }
  }

  // ── Buttons ─────────────────────────────────────────────────────────────

  function updateButtons() {
    document.getElementById('runBtn').disabled = !hasTargets || !hasFrames || isRunning;
  }

  function setRunning(v) {
    isRunning = v;
    document.getElementById('runBtn').innerHTML = v
      ? `<div class="spinner"></div> Processando...`
      : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg> Substituir variáveis`;
    updateButtons();
  }

  // ── Run ─────────────────────────────────────────────────────────────────

  function run() {
    if (isRunning) return;
    setRunning(true);
    document.getElementById('idleHint').style.display   = 'none';
    document.getElementById('phaseStepper').classList.add('visible');
    setPhase('collecting', 'Coletando variáveis...');
    parent.postMessage({ pluginMessage: { type: 'run' } }, '*');
  }

  // ── Tabs ─────────────────────────────────────────────────────────────────

  function switchTab(name) {
    ['ok','skip','fail'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === name);
      document.getElementById(`panel-${t}`).classList.toggle('active', t === name);
    });
  }

  // ── Selection UI ─────────────────────────────────────────────────────────

  function updateSelectionUI(targets, frames) {
    // Don't update selection tags while results are showing — user may be reviewing
    // but we still accept the new data for the next run after going back.
    // Tags will reflect current selection once back on page 1.

    const row   = document.getElementById('targetsRow');
    const empty = document.getElementById('targetsEmpty');
    hasTargets  = targets.length > 0;
    row.querySelectorAll('.tag').forEach(t => t.remove());

    if (hasTargets) {
      row.className = 'tag-row dest-row has-items';
      empty.style.display = 'none';
      targets.forEach(t => {
        const tag = document.createElement('div');
        const cls = t.type === 'COMPONENT_SET' ? 'tag-set'
                  : t.type === 'COMPONENT'     ? 'tag-component' : 'tag-instance';
        const badge = t.type === 'COMPONENT_SET'
          ? `<span class="tag-badge">${t.variantCount}v</span>` : '';
        const label = (t.type === 'INSTANCE' && t.mainName)
          ? `${esc(t.name)} <span style="opacity:.6;font-size:10px">→ ${esc(t.mainName)}</span>`
          : esc(t.name);
        tag.className = `tag ${cls}`;
        tag.innerHTML = `<span class="tag-name">${label}</span>${badge}`;
        row.appendChild(tag);
      });
    } else {
      row.className = 'tag-row dest-row empty-row';
      empty.style.display = '';
    }

    const fRow   = document.getElementById('framesRow');
    const fEmpty = document.getElementById('framesEmpty');
    hasFrames = frames.length > 0;
    fRow.querySelectorAll('.tag').forEach(t => t.remove());

    if (hasFrames) {
      fRow.className = 'tag-row src-row has-items';
      fEmpty.style.display = 'none';
      frames.forEach(f => {
        const tag = document.createElement('div');
        tag.className = 'tag tag-frame';
        tag.innerHTML = `<span class="tag-name" title="${esc(f.name)}">${esc(f.name)}</span>`;
        fRow.appendChild(tag);
      });
    } else {
      fRow.className = 'tag-row src-row empty-row';
      fEmpty.style.display = '';
    }

    updateButtons();
  }

  // ── Results ──────────────────────────────────────────────────────────────

  function displayResults(data) {
    setRunning(false);

    const okItems   = (data.phase1Results || []).filter(r => r.status === 'success');
    const failItems = (data.phase1Results || []).filter(r => r.status === 'failed');
    const skipItems = data.phase2Results || [];

    document.getElementById('statPills').innerHTML = `
      <span class="pill ok">✓ ${okItems.length}</span>
      ${skipItems.length > 0 ? `<span class="pill skip">⚠ ${skipItems.length}</span>` : ''}
      ${failItems.length > 0 ? `<span class="pill fail">✗ ${failItems.length}</span>` : ''}
      <span class="pill neutral">${okItems.length + skipItems.length + failItems.length} total</span>`;

    const tabSkip = document.getElementById('tab-skip');
    const tabFail = document.getElementById('tab-fail');
    tabSkip.style.display = skipItems.length > 0 ? '' : 'none';
    tabFail.style.display = failItems.length > 0 ? '' : 'none';

    document.getElementById('tab-ok').textContent  = `✓ Aplicadas (${okItems.length})`;
    if (skipItems.length > 0) tabSkip.textContent  = `⚠ Ignoradas (${skipItems.length})`;
    if (failItems.length > 0) tabFail.textContent  = `✗ Falhas (${failItems.length})`;

    switchTab('ok');
    renderOkPanel(okItems);
    renderSkipPanel(skipItems);
    renderFailPanel(failItems);

    showResults();
  }

  // ── Icons ─────────────────────────────────────────────────────────────────

  const iconOk   = `<svg class="ri-icon" viewBox="0 0 20 20" fill="#16A34A"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>`;
  const iconFail = `<svg class="ri-icon" viewBox="0 0 20 20" fill="#DC2626"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>`;
  const iconWarn = `<svg class="skip-warn-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>`;

  function propLabel(r) {
    if (!r.property || r.property === '—') return null;
    if (r.property === 'textStyleId')   return 'text style';
    if (r.property === 'effectStyleId') return 'effect style';
    return r.paintSubProp ? `${r.property}[${r.paintIndex ?? 0}].${r.paintSubProp}` : r.property;
  }

  function short(name) {
    const parts = String(name).split('/');
    return parts.length > 2 ? `…/${parts.slice(-2).join('/')}` : name;
  }

  function esc(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderOkPanel(items) {
    const panel = document.getElementById('panel-ok');
    if (!items.length) {
      panel.innerHTML = `<div class="tab-empty">Nenhuma substituição foi aplicada.<br>As variáveis já podem estar corretas ou sem nomes em comum.</div>`;
      return;
    }
    panel.innerHTML = items.map(r => {
      const pl = propLabel(r);
      const isStyleSwap = r.property === 'textStyleId' || r.property === 'effectStyleId';
      const detail = isStyleSwap
        ? `${pl ? `<span class="ri-prop">${esc(pl)}</span>` : ''}${esc(short(r.oldVariableName))}`
        : `${pl ? `<span class="ri-prop">${esc(pl)}</span>` : ''}${esc(short(r.oldVariableName))}<span class="ri-arrow">→</span>${esc(short(r.newVariableName ?? ''))}`;
      return `<div class="result-item ok">
        ${iconOk}
        <div class="ri-body">
          <div class="ri-node">${esc(r.nodeName)}</div>
          <div class="ri-detail">${detail}</div>
        </div>
      </div>`;
    }).join('');
  }

  // skip state: name → { nodeIds, selected, done, el }
  const skipState = new Map();
  let lastClickedSkip = null; // for shift-range selection

  function syncFigmaSelection() {
    const ids = [...skipState.values()]
      .filter(g => g.selected && !g.done)
      .flatMap(g => g.nodeIds);
    parent.postMessage({ pluginMessage: { type: 'select-nodes', nodeIds: ids } }, '*');
  }

  function renderSkipPanel(items) {
    const panel = document.getElementById('panel-skip');
    skipState.clear();
    lastClickedSkip = null;

    if (!items.length) {
      panel.innerHTML = `<div class="tab-empty">Nenhuma instância externa foi ignorada.</div>`;
      return;
    }

    const byName = new Map();
    for (const r of items) {
      if (!byName.has(r.nodeName)) byName.set(r.nodeName, { nodeIds: [] });
      byName.get(r.nodeName).nodeIds.push(r.nodeId);
    }
    const sorted = [...byName.entries()].sort((a, b) => b[1].nodeIds.length - a[1].nodeIds.length);
    const orderedNames = sorted.map(([n]) => n);

    panel.innerHTML = '';

    for (const [name, { nodeIds }] of sorted) {
      const count = nodeIds.length;
      const ids   = [...nodeIds];

      const group = document.createElement('div');
      group.className = 'skip-group';
      group.innerHTML = `
        ${iconWarn}
        <span class="skip-name-label">${esc(name)}</span>
        <span class="skip-name-count">${count} instância${count !== 1 ? 's' : ''}</span>
        <button class="skip-done-toggle">feito</button>`;

      const state = { nodeIds: ids, selected: false, done: false, el: group };
      skipState.set(name, state);

      // Click on row = select in Figma (+ shift for multi-select highlight)
      group.addEventListener('click', (e) => {
        if (e.target.closest('.skip-done-toggle')) return;
        if (state.done) return;

        const isMeta = e.shiftKey || e.ctrlKey || e.metaKey;

        if (e.shiftKey && lastClickedSkip && lastClickedSkip !== name) {
          // Shift: range-select between lastClicked and this
          const a = orderedNames.indexOf(lastClickedSkip);
          const b = orderedNames.indexOf(name);
          const [lo, hi] = a < b ? [a, b] : [b, a];
          for (let i = lo; i <= hi; i++) {
            const s = skipState.get(orderedNames[i]);
            if (s && !s.done) {
              s.selected = true;
              s.el.classList.add('selected');
            }
          }
        } else if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
          // Ctrl/Cmd: toggle this item without clearing others
          state.selected = !state.selected;
          group.classList.toggle('selected', state.selected);
          lastClickedSkip = name;
        } else {
          // Single click — clear all, select only this one
          for (const s of skipState.values()) {
            s.selected = false;
            s.el.classList.remove('selected');
          }
          state.selected = true;
          group.classList.add('selected');
          lastClickedSkip = name;
        }

        syncFigmaSelection();
      });

      // Done toggle — independent of row click
      group.querySelector('.skip-done-toggle').addEventListener('click', (e) => {
        e.stopPropagation();
        state.done = !state.done;
        group.classList.toggle('done', state.done);
        if (state.done) {
          state.selected = false;
          group.classList.remove('selected');
          group.querySelector('.skip-done-toggle').textContent = '✓ feito';
        } else {
          group.querySelector('.skip-done-toggle').textContent = 'feito';
        }
        syncFigmaSelection();
      });

      panel.appendChild(group);
    }
  }

  function renderFailPanel(items) {
    const panel = document.getElementById('panel-fail');
    if (!items.length) {
      panel.innerHTML = `<div class="tab-empty">Nenhuma falha registrada.</div>`;
      return;
    }
    panel.innerHTML = items.map(r => {
      const pl = propLabel(r);
      return `<div class="result-item fail">
        ${iconFail}
        <div class="ri-body">
          <div class="ri-node">${esc(r.nodeName)}</div>
          <div class="ri-detail">
            ${pl ? `<span class="ri-prop">${esc(pl)}</span>` : ''}
            ${esc(short(r.oldVariableName))}
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // ── Messages ─────────────────────────────────────────────────────────────

  onmessage = (e) => {
    const msg = e.data.pluginMessage;
    if (!msg) return;

    if (msg.type === 'selection') updateSelectionUI(msg.targets, msg.frames);

    if (msg.type === 'phase') setPhase(msg.phase, msg.message);

    if (msg.type === 'done') displayResults(msg);

    if (msg.type === 'error') {
      setRunning(false);
      document.getElementById('phaseStepper').classList.remove('visible');
      const hint = document.getElementById('idleHint');
      hint.style.display = 'flex';
      hint.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span style="color:#DC2626;font-weight:500">Erro: ${esc(msg.message)}</span>`;
    }
  };

  parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
</script>
</body>
</html>