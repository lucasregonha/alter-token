<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      font-family: "Inter", sans-serif;
      font-size: 13px;
      background: #F4F4F5;
      color: #18181B;
    }

    body {
      display: flex;
      flex-direction: column;
      padding: 14px;
      gap: 10px;
      overflow: hidden;
    }

    /* ── HEADER ──────────────────────────────────────────── */
    .header h1 { font-size: 14px; font-weight: 600; }
    .header .subtitle { font-size: 11px; color: rgba(24,24,27,0.5); margin-top: 2px; line-height: 1.4; }

    /* ── SELECTION ───────────────────────────────────────── */
    .selection-panel { display: flex; flex-direction: column; gap: 6px; }

    .panel-label {
      font-size: 10px; font-weight: 600; letter-spacing: 0.06em;
      text-transform: uppercase; color: rgba(24,24,27,0.45); padding: 0 2px;
    }

    .tag-row {
      display: flex; flex-wrap: wrap; gap: 5px;
      padding: 8px 10px;
      background: white;
      border-radius: 8px;
      border: 1.5px solid #E4E4E7;
      min-height: 38px;
      align-items: center;
    }
    .tag-row.has-items { border-color: #4361EE; }
    .tag-row.dest-row.has-items { border-color: #7C3AED; }
    .tag-row.empty-row { border-style: dashed; }

    .empty-hint { font-size: 11px; color: rgba(24,24,27,0.35); }

    .tag {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 7px 3px 5px;
      border-radius: 5px;
      font-size: 11px; font-weight: 500;
      max-width: 200px;
    }
    .tag-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tag-badge {
      font-size: 9px; font-weight: 700;
      background: rgba(0,0,0,0.12);
      border-radius: 3px; padding: 1px 4px; flex-shrink: 0;
    }

    /* tag colors by type */
    .tag-set      { background: #F5F0FF; color: #6D28D9; border: 1px solid #DDD6FE; }
    .tag-component{ background: #EEF1FD; color: #3730A3; border: 1px solid #C7D2FE; }
    .tag-instance { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
    .tag-frame    { background: #F0FDF4; color: #15803D; border: 1px solid #BBF7D0; }

    /* ── DIVIDER ─────────────────────────────────────────── */
    .divider { height: 1px; background: #E4E4E7; }

    /* ── RUN BUTTON ──────────────────────────────────────── */
    .run-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 20px;
      background: #4361EE; color: white;
      font-family: "Inter", sans-serif;
      font-size: 13px; font-weight: 600;
      border: none; border-radius: 8px;
      cursor: pointer; transition: background 0.15s; width: 100%;
    }
    .run-btn:hover:not(:disabled) { background: #2D41E3; }
    .run-btn:disabled { opacity: 0.38; cursor: not-allowed; }
    .run-btn svg { width: 14px; height: 14px; flex-shrink: 0; }

    /* ── STATUS ──────────────────────────────────────────── */
    .status-area {
      flex: 1; overflow: hidden;
      display: flex; flex-direction: column; gap: 8px; min-height: 0;
    }
    .status-text {
      font-size: 11px; color: rgba(24,24,27,0.55);
      text-align: center; padding: 4px 0;
    }
    .status-text.error { color: #DC2626; font-weight: 500; }

    /* ── RESULTS ─────────────────────────────────────────── */
    .results-box {
      border: 1.5px solid #E4E4E7; border-radius: 10px;
      background: white; overflow: hidden;
      flex: 1; display: flex; flex-direction: column; min-height: 0;
    }
    .results-header {
      padding: 9px 12px; border-bottom: 1px solid #E4E4E7;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .results-header-title { font-size: 12px; font-weight: 600; }

    .stat-pills { display: flex; gap: 4px; flex-wrap: wrap; }
    .pill { font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 20px; }
    .pill.ok      { background: #DCFCE7; color: #15803D; }
    .pill.fail    { background: #FEE2E2; color: #B91C1C; }
    .pill.skip    { background: #FEF9C3; color: #854D0E; }
    .pill.neutral { background: #F4F4F5; color: rgba(24,24,27,0.55); }

    /* Tabs */
    .result-tabs { display: flex; border-bottom: 1px solid #E4E4E7; flex-shrink: 0; }
    .result-tab {
      flex: 1; padding: 7px 0;
      font-size: 11px; font-weight: 500;
      color: rgba(24,24,27,0.45);
      cursor: pointer; text-align: center;
      border-bottom: 2px solid transparent;
      transition: all 0.15s; user-select: none;
    }
    .result-tab.active           { color: #4361EE; border-bottom-color: #4361EE; }
    .result-tab.skip-tab.active  { color: #92400E; border-bottom-color: #D97706; }
    .result-tab.fail-tab.active  { color: #B91C1C; border-bottom-color: #DC2626; }

    .tab-panel { display: none; flex: 1; overflow-y: auto; padding: 8px; flex-direction: column; gap: 4px; }
    .tab-panel.active { display: flex; }

    /* Items */
    .result-item {
      display: flex; align-items: flex-start; gap: 7px;
      padding: 7px 9px; border-radius: 7px;
    }
    .result-item.ok   { background: #F0FDF4; }
    .result-item.fail { background: #FEF2F2; }
    .result-item.skip { background: #FFFBEB; }

    .ri-icon { width: 14px; height: 14px; flex-shrink: 0; margin-top: 1px; }
    .ri-body { flex: 1; min-width: 0; }
    .ri-node { font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ri-detail { font-size: 10px; color: rgba(24,24,27,0.5); margin-top: 2px; line-height: 1.4; }
    .ri-arrow { color: #4361EE; font-weight: 700; margin: 0 3px; }
    .ri-prop {
      display: inline-block;
      background: #EEF1FD; color: #4361EE;
      font-size: 9px; font-weight: 600;
      border-radius: 3px; padding: 1px 4px; margin-right: 4px;
    }
    .ri-reason { font-size: 10px; color: #92400E; margin-top: 2px; font-style: italic; }

    /* Idle */
    .idle-hint {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 8px; color: rgba(24,24,27,0.35);
      font-size: 11px; text-align: center; padding: 16px; line-height: 1.5;
    }
    .idle-hint svg { width: 28px; height: 28px; }

    .tab-empty {
      flex: 1; display: flex; align-items: center; justify-content: center;
      font-size: 11px; color: rgba(24,24,27,0.4);
      text-align: center; padding: 16px; line-height: 1.5;
    }

    /* Spinner */
    .spinner {
      width: 15px; height: 15px;
      border: 2px solid rgba(255,255,255,0.35);
      border-top-color: white; border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: inline-block; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <h1>Variable Substitution</h1>
    <div class="subtitle">Substitui variáveis por nome — aceita Component Set, Component ou Instance como destino</div>
  </div>

  <!-- SELECTION -->
  <div class="selection-panel">

    <div class="panel-label">Destino — Component Set / Component / Instance</div>
    <div class="tag-row dest-row empty-row" id="targetsRow">
      <span class="empty-hint" id="targetsEmpty">Selecione componentes ou component sets</span>
    </div>

    <div class="panel-label">Origem das variáveis — Frames</div>
    <div class="tag-row empty-row" id="framesRow">
      <span class="empty-hint" id="framesEmpty">Selecione um ou mais Frames</span>
    </div>

  </div>

  <div class="divider"></div>

  <button class="run-btn" id="runBtn" disabled onclick="run()">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
    Substituir variáveis
  </button>

  <!-- STATUS + RESULTS -->
  <div class="status-area">

    <div class="idle-hint" id="idleHint">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v4l3 3"/>
      </svg>
      Selecione os destinos e os frames de origem, depois clique em "Substituir variáveis"
    </div>

    <div class="status-text" id="statusMsg" style="display:none"></div>

    <div class="results-box" id="resultsBox" style="display:none">
      <div class="results-header">
        <span class="results-header-title">Resultado</span>
        <div class="stat-pills" id="statPills"></div>
      </div>

      <div class="result-tabs">
        <div class="result-tab active"   onclick="switchTab('ok')"   id="tab-ok">✓ Aplicadas</div>
        <div class="result-tab skip-tab" onclick="switchTab('skip')" id="tab-skip" style="display:none">⚠ Ignoradas</div>
        <div class="result-tab fail-tab" onclick="switchTab('fail')" id="tab-fail" style="display:none">✗ Falhas</div>
      </div>

      <div class="tab-panel active" id="panel-ok"></div>
      <div class="tab-panel"        id="panel-skip"></div>
      <div class="tab-panel"        id="panel-fail"></div>
    </div>

  </div>

  <script>
    let hasTargets = false;
    let hasFrames  = false;
    let isRunning  = false;

    // ── Selection UI ─────────────────────────────────────────────

    function updateSelectionUI(targets, frames) {
      const row   = document.getElementById('targetsRow');
      const empty = document.getElementById('targetsEmpty');
      hasTargets  = targets.length > 0;

      row.querySelectorAll('.tag').forEach(t => t.remove());

      if (hasTargets) {
        row.className = 'tag-row dest-row has-items';
        empty.style.display = 'none';
        targets.forEach(t => {
          const tag = document.createElement('div');
          const cls = t.type === 'COMPONENT_SET' ? 'tag-set'
                    : t.type === 'COMPONENT'     ? 'tag-component'
                    : 'tag-instance';
          const badge = t.type === 'COMPONENT_SET'
            ? `<span class="tag-badge">${t.variantCount}v</span>`
            : '';
          const label = t.type === 'INSTANCE' && t.mainName
            ? `${esc(t.name)} <span style="opacity:.6;font-size:10px">→ ${esc(t.mainName)}</span>`
            : esc(t.name);
          tag.className = `tag ${cls}`;
          tag.innerHTML = `<span class="tag-name">${label}</span>${badge}`;
          row.appendChild(tag);
        });
      } else {
        row.className = 'tag-row dest-row empty-row';
        empty.style.display = '';
      }

      const fRow   = document.getElementById('framesRow');
      const fEmpty = document.getElementById('framesEmpty');
      hasFrames = frames.length > 0;
      fRow.querySelectorAll('.tag').forEach(t => t.remove());

      if (hasFrames) {
        fRow.className = 'tag-row has-items';
        fEmpty.style.display = 'none';
        frames.forEach(f => {
          const tag = document.createElement('div');
          tag.className = 'tag tag-frame';
          tag.innerHTML = `<span class="tag-name" title="${esc(f.name)}">${esc(f.name)}</span>`;
          fRow.appendChild(tag);
        });
      } else {
        fRow.className = 'tag-row empty-row';
        fEmpty.style.display = '';
      }

      updateRunBtn();
    }

    function updateRunBtn() {
      document.getElementById('runBtn').disabled = !hasTargets || !hasFrames || isRunning;
    }

    // ── Run ──────────────────────────────────────────────────────

    function setRunning(running) {
      isRunning = running;
      document.getElementById('runBtn').innerHTML = running
        ? `<div class="spinner"></div> Processando...`
        : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg> Substituir variáveis`;
      updateRunBtn();
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.style.display = 'block';
      el.textContent = msg;
      el.className = `status-text ${type || ''}`;
    }

    function run() {
      if (isRunning) return;
      setRunning(true);
      document.getElementById('idleHint').style.display = 'none';
      document.getElementById('resultsBox').style.display = 'none';
      showStatus('Iniciando...', '');
      parent.postMessage({ pluginMessage: { type: 'run' } }, '*');
    }

    // ── Tabs ─────────────────────────────────────────────────────

    function switchTab(name) {
      ['ok','skip','fail'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('active', t === name);
        document.getElementById(`panel-${t}`).classList.toggle('active', t === name);
      });
    }

    // ── Results ──────────────────────────────────────────────────

    function showResults(data) {
      document.getElementById('idleHint').style.display = 'none';
      document.getElementById('statusMsg').style.display = 'none';

      const box = document.getElementById('resultsBox');
      box.style.display = 'flex';

      document.getElementById('statPills').innerHTML = `
        <span class="pill ok">✓ ${data.successCount}</span>
        ${data.skippedInstanceCount > 0 ? `<span class="pill skip">⚠ ${data.skippedInstanceCount}</span>` : ''}
        ${data.failedCount > 0          ? `<span class="pill fail">✗ ${data.failedCount}</span>`          : ''}
        <span class="pill neutral">${data.total} total</span>`;

      const tabSkip = document.getElementById('tab-skip');
      const tabFail = document.getElementById('tab-fail');
      tabSkip.style.display = data.skippedInstanceCount > 0 ? '' : 'none';
      tabFail.style.display = data.failedCount          > 0 ? '' : 'none';

      document.getElementById('tab-ok').textContent   = `✓ Aplicadas (${data.successCount})`;
      if (data.skippedInstanceCount > 0) tabSkip.textContent = `⚠ Ignoradas (${data.skippedInstanceCount})`;
      if (data.failedCount > 0)          tabFail.textContent = `✗ Falhas (${data.failedCount})`;

      renderPanel('ok',   data.results.filter(r => r.status === 'success'),          renderOk);
      renderPanel('skip', data.results.filter(r => r.status === 'skipped_instance'), renderSkip);
      renderPanel('fail', data.results.filter(r => r.status === 'failed'),            renderFail);
    }

    function renderPanel(name, items, renderer) {
      const panel = document.getElementById(`panel-${name}`);
      panel.innerHTML = items.length === 0
        ? `<div class="tab-empty">${tabEmptyMsg(name)}</div>`
        : items.map(renderer).join('');
    }

    function tabEmptyMsg(tab) {
      if (tab === 'ok')   return 'Nenhuma substituição foi aplicada.<br>As variáveis já podem estar corretas ou sem nomes em comum.';
      if (tab === 'skip') return 'Nenhuma instância foi ignorada.';
      return 'Nenhuma falha registrada.';
    }

    const iconOk   = `<svg class="ri-icon" viewBox="0 0 20 20" fill="#16A34A"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>`;
    const iconWarn = `<svg class="ri-icon" viewBox="0 0 20 20" fill="#D97706"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>`;
    const iconFail = `<svg class="ri-icon" viewBox="0 0 20 20" fill="#DC2626"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>`;

    function propLabel(r) {
      return r.paintSubProp
        ? `${r.property}[${r.paintIndex ?? 0}].${r.paintSubProp}`
        : r.property;
    }

    function renderOk(r) {
      return `<div class="result-item ok">
        ${iconOk}
        <div class="ri-body">
          <div class="ri-node">${esc(r.nodeName)}</div>
          <div class="ri-detail">
            <span class="ri-prop">${esc(propLabel(r))}</span>
            ${esc(short(r.oldVariableName))}
            <span class="ri-arrow">→</span>
            ${esc(short(r.newVariableName ?? ''))}
          </div>
        </div>
      </div>`;
    }

    function renderSkip(r) {
      return `<div class="result-item skip">
        ${iconWarn}
        <div class="ri-body">
          <div class="ri-node">${esc(r.nodeName)}</div>
          <div class="ri-detail">
            <span class="ri-prop">${esc(propLabel(r))}</span>
            ${esc(short(r.oldVariableName))}
            <span class="ri-arrow">→</span>
            ${esc(short(r.newVariableName ?? ''))}
          </div>
          <div class="ri-reason">${esc(r.reason ?? '')}</div>
        </div>
      </div>`;
    }

    function renderFail(r) {
      return `<div class="result-item fail">
        ${iconFail}
        <div class="ri-body">
          <div class="ri-node">${esc(r.nodeName)}</div>
          <div class="ri-detail">
            <span class="ri-prop">${esc(propLabel(r))}</span>
            ${esc(short(r.oldVariableName))}
          </div>
        </div>
      </div>`;
    }

    function short(name) {
      const parts = String(name).split('/');
      return parts.length > 2 ? `…/${parts.slice(-2).join('/')}` : name;
    }

    function esc(str) {
      return String(str)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ── Messages ─────────────────────────────────────────────────

    onmessage = (e) => {
      const msg = e.data.pluginMessage;
      if (!msg) return;
      if (msg.type === 'selection') updateSelectionUI(msg.targets, msg.frames);
      if (msg.type === 'status')    showStatus(msg.message, '');
      if (msg.type === 'done')    { setRunning(false); showResults(msg); }
      if (msg.type === 'error')   { setRunning(false); showStatus('Erro: ' + msg.message, 'error'); }
    };

    parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
  </script>
</body>
</html>